<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib\html-parsers\index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">lib/html-parsers/</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">30.49% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>25/82</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/55</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">58.82% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>10/17</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">33.33% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>25/75</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict'
&nbsp;
import config from 'config'
import http from 'http'
import https from 'https'
import querystring from 'querystring'
import zlib from 'zlib'
import { notFound200, codeKo200 } from './false-error-codes'
&nbsp;
/**
 * Helper to send an HTTP request to Myfox services, and parse response stream.
 * You will use this to analyze Myfox HTML response from an HTTP query,
 * and to avoid parsing general events like errors, authentication problems, etc...
 *
 * @param {string} method The HTTP method, in upper case (GET, POST, PUT, PATCH, DELETE, ...)
 * @param {string} path The URL path part (without query string and host parts), like '/home/1234'
 * @param {object} streamParser a stream parser to pipe on the distant response stream
 * @param {function} callback The callback function to call after parsing (will take (err, data) as arguments)
 * @param {object} queryParams An object to serialize into the query string
 * @param {object} payload An object to serialize as the request payload
 * @param {object} headers An object to push into the request headers
 * @param {function} cookieJar The function that will get/set the data to keep between each query (mainly the Cookie)
 */
export <span class="fstat-no" title="function not covered" >function httpsRequest (method, path, streamParser, callback, queryParams, payload, headers, cookieJar) <span class="cstat-no" title="statement not covered" >{</span></span>
  // POST / PUT / PATCH cases
<span class="cstat-no" title="statement not covered" ></span>  if (payload) {
<span class="cstat-no" title="statement not covered" >    payload = querystring.stringify(payload) // encoded as querystring for login needs.</span>
  }
<span class="cstat-no" title="statement not covered" >  const postHeaders = (</span>payload &amp;&amp; (method === 'POST' || method === 'PUT' || method === 'PATCH')) ? {
    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    'Content-Length': payload.length
  } : {}
&nbsp;
  // Query parameters to path
  if (queryParams &amp;&amp; queryParams.constructor === Object &amp;&amp; Object.keys(queryParams).length &gt; 0) {
<span class="cstat-no" title="statement not covered" >    queryParams = querystring.stringify(queryParams)</span>
<span class="cstat-no" title="statement not covered" >    path = path + '?' + queryParams</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  try <span class="cstat-no" title="statement not covered" ></span>{</span>
<span class="cstat-no" title="statement not covered" >    let cookie = (cookieJar !== null &amp;&amp; cookieJar !== undefined &amp;&amp; cookieJar().cookie !== undefined) ? {'cookie': [cookieJar().cookie]} : {}</span>
<span class="cstat-no" title="statement not covered" >    let r</span>equestData = {
      hostname: config.get('myfox-wrapper-api.html.myfox.hostname'),
      port: config.get('myfox-wrapper-api.html.myfox.port'),
      path: path,
      headers: Object.assign(postHeaders, config.get('myfox-wrapper-api.html.myfox.headers'), cookie, headers),
      method: method
    }
    // console.log('Sending request to Myfox:', requestData)
&nbsp;
    let req = ((config.get('myfox-wrapper-api.html.myfox.protocol') === 'http') ? http : https).request(requestData, <span class="fstat-no" title="function not covered" >(res) =&gt; <span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ></span></span></span></span></span>{</span></span>
      // console.log('Receiving response:', res.statusCode, res.headers)
      // If HTTP error case, no need to parse the body
<span class="cstat-no" title="statement not covered" ></span>      if (res.statusCode &gt;= 400) {
<span class="cstat-no" title="statement not covered" >        const error = new Error('Error status code returned by Myfox.')</span>
<span class="cstat-no" title="statement not covered" >        error.status = res.statusCode</span>
<span class="cstat-no" title="statement not covered" >        return callback(error)</span>
      }
&nbsp;
      // If false HTTP codes, fix them
      if (res.statusCode === 302 &amp;&amp; res.headers.location === config.get('myfox-wrapper-api.html.myfox.redirectForbidden')) {
<span class="cstat-no" title="statement not covered" >        const error = new Error('Myfox redirected to / because of forbidden access.')</span>
<span class="cstat-no" title="statement not covered" >        error.status = 403</span>
<span class="cstat-no" title="statement not covered" >        return callback(error)</span>
      }
&nbsp;
      // get Set-Cookie response header value to use it later
      let setCookie = res.headers['set-cookie']
<span class="cstat-no" title="statement not covered" ></span>      if (setCookie !== null &amp;&amp; cookieJar !== null &amp;&amp; cookieJar !== undefined) {
<span class="cstat-no" title="statement not covered" >        cookieJar({'cookie': setCookie[0].replace(/ ?expires=[^;]*;/, '').replace(/ ?path=\//, '').trim()})</span>
      }
&nbsp;
      // From here we need body data. Sometimes it can be zipped!
      let unzippedRes
<span class="cstat-no" title="statement not covered" >      let encoding = res.headers['content-encoding']</span>
<span class="cstat-no" title="statement not covered" >      if (encoding === 'gzip') {</span>
<span class="cstat-no" title="statement not covered" >        unzippedRes = res.pipe(zlib.createGunzip())</span>
      } else <span class="cstat-no" title="statement not covered" ></span>if (encoding === 'deflate') {
<span class="cstat-no" title="statement not covered" >        unzippedRes = res.pipe(zlib.createInflate())</span>
      } else {
<span class="cstat-no" title="statement not covered" >        unzippedRes = res</span>
      }
&nbsp;
      // From here we start to analyze the content of the data. Keep it in a buffer anyway.
      unzippedRes.setEncoding('utf8')
<span class="cstat-no" title="statement not covered" >      let buffer = ''</span>
<span class="cstat-no" title="statement not covered" >      unzippedRes.on('data', <span class="fstat-no" title="function not covered" >(chunk) =&gt; {</span></span>
<span class="cstat-no" title="statement not covered" >        buffer += chunk</span>
      })
&nbsp;
<span class="cstat-no" title="statement not covered" >      let notFound200Instance = notFound200()</span>
<span class="cstat-no" title="statement not covered" >      unzippedRes.pipe(notFound200Instance) // Change 'Page not found' code 200 by 404</span>
      notFound200Instance.on('error', callback)
&nbsp;
<span class="cstat-no" title="statement not covered" >      let codeKo200Instance = codeKo200()</span>
<span class="cstat-no" title="statement not covered" >      unzippedRes.pipe(codeKo200Instance) // Change code KO with 200 by 400 and fetch the message</span>
      codeKo200Instance.on('error', <span class="fstat-no" title="function not covered" >(err) =&gt; {</span>
<span class="cstat-no" title="statement not covered" ></span>        if (err.status === 400) {
<span class="cstat-no" title="statement not covered" >          callback(err, null)</span>
        } // else it's not JSON data!
      })
&nbsp;
<span class="cstat-no" title="statement not covered" ></span>      if (streamParser !== null &amp;&amp; streamParser !== undefined) {
        // There is a streamParser. 'end' event is plugged on streamParser, not unzippedRes.
<span class="cstat-no" title="statement not covered" >        unzippedRes.pipe(streamParser)</span>
<span class="cstat-no" title="statement not covered" >        streamParser.on('end', <span class="fstat-no" title="function not covered" >() =&gt; {</span></span>
<span class="cstat-no" title="statement not covered" >          callback(null, streamParser)</span>
        })
      } else {
        // There is no streamParser, so all bufferized data will be returned at the 'end' event.
<span class="cstat-no" title="statement not covered" >        unzippedRes.on('end', <span class="fstat-no" title="function not covered" >() =&gt; {</span></span>
<span class="cstat-no" title="statement not covered" >          callback(null, buffer)</span>
        })
      }
    })
&nbsp;
<span class="cstat-no" title="statement not covered" ></span>    if (streamParser !== null &amp;&amp; streamParser !== undefined) {
<span class="cstat-no" title="statement not covered" >      streamParser.on('error', callback)</span>
    }
<span class="cstat-no" title="statement not covered" >    req.on('error', callback)</span>
&nbsp;
<span class="cstat-no" title="statement not covered" ></span>    if (payload &amp;&amp; (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
<span class="cstat-no" title="statement not covered" >      req.write(payload)</span>
    }
<span class="cstat-no" title="statement not covered" >    req.end()</span>
  } catch (err) {
<span class="cstat-no" title="statement not covered" >    console.error('requestData() encounter exception parsing Myfox response.', err)</span>
<span class="cstat-no" title="statement not covered" ></span>    if (err.status === null || err.status === undefined) {
<span class="cstat-no" title="statement not covered" >      err.status = 500</span>
    }
<span class="cstat-no" title="statement not covered" >    return callback(err)</span>
  }
}
&nbsp;
/**
 * Returns a function to generate a stream parser for a given HTML element, passed to the given callback.
 *
 * @param  {function}  callback  The callback function to give to the inner text stream parser.
 * @return {function}  A function generating a stream parser to retrieve inner text.
 */
export function trumpetInnerText (callback) {
  return function (element) {
    let buffer = ''
    const stream = element.createReadStream()
    stream.setEncoding('utf8')
    stream.on('data', (chunk) =&gt; {
      buffer += chunk
    })
    stream.on('end', () =&gt; {
      callback(buffer.trim())
    })
    stream.on('error', <span class="fstat-no" title="function not covered" >(err) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      throw new Error(err)</span>
    })
  }
}
&nbsp;
/**
 * Returns a function to call back with all CSS classes found on the given element.
 *
 * @param  {function}  callback  The callback function to give to the CSS class extractor.
 * @return {function}  A function that will call callback with the array of CSS classes found on the element.
 */
export function trumpetClasses (callback) {
  return function (element) {
    element.getAttribute('class', (classes) =&gt; {
      callback(classes.split(' '))
    })
  }
}
&nbsp;
/**
 * Returns a function to call back with the attribute value found on the given element.
 *
 * @param  {string}    attributeName  The attribute name to retrieve.
 * @param  {function}  callback       The callback function to give to the attribute extractor.
 * @return {function}  A function that will call callback with the value of the attribute found on the element. If no attribute is found, then the callback is not called!
 */
export function trumpetAttr (attributeName, callback) {
  return function (element) {
    element.getAttribute(attributeName, (attributeValue) =&gt; {
      callback(attributeValue)
    })
  }
}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Aug 24 2016 18:41:17 GMT+0200 (Paris, Madrid (heure d’été))
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
